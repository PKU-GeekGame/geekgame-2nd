# [Algorithm] 乱码还原

- 命题人：debugger
- Flag 1：200 分
- Flag 2：250 分

## 题目描述

<blockquote>
<p>将需要打码的文字输入在上面的文本框里，点击『听佛说宇宙的真谛』按钮，就能在下面得到打码后的文字。</p>
<p>将需要解码的文字输入在下面的文本框里，记得带上『佛曰：』或『如是我闻：』的文字，点击『参悟佛所言的真意』按钮，就能在上面的文本框里得到解码后的文字。</p>
<p>顺便说下，为什么有时候会出现『太深奥了，参悟不出佛经的真意……』的情况，那是因为某些深井冰的网站（百度说的就是你！），会将繁体字转换为简体字，这样你复制后的文字已经不是最初的原文了，所以解不出。本佛祖的代言人已经尽力的去尝试参悟了，可惜还是有部分被篡改的佛语无能为力，十分抱歉o(&gt;﹏&lt;)o</p>
</blockquote>
<div style="text-align:right;">
<p>——<a target="_blank" rel="noopener noreferrer" href="https://www.keyfc.net/bbs/tools/tudoucode.aspx">与佛论禅</a></p>
</div>
<p>小 Z 身在日本，有人给小 Z 发了一大段佛语，但是小 Z 一打开，全是乱码。这该怎么办啊？</p>
<div class="well">
<p><strong>第二阶段提示：</strong></p>
<ul>
<li>可以先用Encrypt函数随便加密一段文本，然后转成Shift-JIS，看看转成Shift-JIS的过程会发生什么变化（这不是无损的转换）。</li>
<li>AES是分组密码，可以了解一下分组密码的原理。</li>
</ul>
</div>

**[【附件：下载题目附件（prob18.zip）】](attachment/prob18.zip)**

## 预期解法

第一步是从原始密文还原出可能的与佛论禅密文集合。

与佛论禅加密后的密文含有汉字、冒号和句号，这些字符在UTF-8里面都是用3个字节编码，其中第一个字节在0xe0和0xef之间，后两个在0x80和0xbf之间。所有汉字都在“中日韩统一表意文字”这个Unicode区块中，该区块的范围为U+4E00–U+9FFF，对应的UTF-8编码范围为e4 b8 80-e9 bf bf。冒号和句号分别编码为ef bc 9a和e3 80 82。

接着，结果会用Shift JIS解码。Shift JIS是一种变长编码，其中单字节字符为0x00-0x7f、0xa1-0xdf，双字节字符第一字节范围为0x81-0x9f和0xe0-0xfc（但是JIS X 0208只使用0x81-0x84、0x88-0x9f和0xe0-0xea），第二字节为0x40-0xfc（不含0x7f）。和UTF-8不同的是，Shift JIS不是自同步码，也即从不同地方开始解码结果会不同。此外，根据[Shift JIS码表](https://uic.io/en/charset/show/cp932/)，第一个字节在0xe0和0xef之间、第二字节在0x80和0xbf之间的字符是一定存在的；第一个字节在0x81和0x9f之间则不一定存在。

现在考虑用Shift JIS从UTF-8的各字节开始解码的情况：
1. 如果从第一个字节开始解码：当字符不是冒号时，前两个字节能构成一个合法的Shift JIS字符，然后从第三字节继续解码。如果是冒号，因为JIS X 0208没有第一字节为0xef的字符，所以这个字节会被丢弃，从第二个字节继续解码。
2. 如果从第二个字节开始解码：如果该字节在0x81-0x84或0x88-0x9f，则第2、3字节可能能构成一个合法的Shift JIS字符，然后从下一字符第一字节继续解码；如果该字节在0xa1-0xbf，是合法的单字节字符，然后从第三字节继续解码；如果是0x80、0x85-0x87、0xa0或者没有构成合法的字符，则会丢弃该字节。
3. 如果从第三个字节开始解码，和上面类似。

总之：除非字符是冒号，UTF-8的第一个字节不会被丢弃；第二个和第三个字节可能被丢弃（甚至可能都被丢弃，例如“者”的UTF-8是e8 80 85，如果从第二字节开始解码，因为没有以0x80或者0x85开始的Shift JIS字符，所以两个字节都会被丢弃。

把密文用Shift JIS编码后，可以以0xe0和0xef之间的字节为起始分段（但是冒号需要特殊处理）。接着对与佛论禅密文的所有可能字符UTF-8编码后去除第二和/或第三字节，存储在一个检索表里面，这样对于每一分段，可以知道可能的原始字符。

当然，如果你不知道Shift JIS的工作原理，通过尝试转换一些文本也可以知道编码后的密文每个以0xe0-0xef起始的片段对应与佛论禅密文的一个（冒号外的）字符。因此对应的与佛论禅密文长度是确定的，而且其中多数字符也是确定的。

接着要解密与佛论禅密文。

对于Flag 1，可能的密文（包括合法和非法的）只有3840个，所以可以枚举所有可能的与佛论禅密文，尝试解密即可。Flag 2枚举密文是不可能的。

与佛论禅的工作原理是：
1. 把原文用UTF-16LE编码
2. pad到长度为16的倍数
3. 用AES-CBC加密，key和iv都是已知的
4. 小于128的byte从TUDOU码表选择对应的字符（生成1个字符），大于等于128的先从BYTEMARK随机选一个字符，再从TUDOU选该byte减去128对应的字符（生成2个字符）
5. 加上前缀“佛曰：”，然后输出

其中TUDOU和BYTEMARK是两个交集为空的字符数组。

从中可以得知：
1. 两个BYTEMARK不可能相邻
2. 密文去除前缀后，TUDOU的数量必须是16的倍数
3. 因为AES分组大小为16，如果得到了16个TUDOU，可以先解密这一部分密文

因此可以使用DFS搜索，每次搜索到16个TUDOU后尝试解密，如果里面有非ASCII字符（pad字符除外）则不用再搜索该分支。注意不能使用递归实现搜索，否则栈深度会溢出；也不应该在栈里面保存每一步的完整明文或密文，否则内存可能不够用。

decode.py实现了一种搜索算法，从初始状态开始，每次搜索16个TUDOU后的所有可能状态，然后筛选出解密仅有ASCII字符的状态（通常仅有一个），如此循环直到所有密文被解密为止。
